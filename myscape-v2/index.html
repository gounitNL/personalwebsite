<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyScape Enhanced - RuneScape-Style MMORPG</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1 class="game-title-login">‚öîÔ∏è MyScape Enhanced</h1>
            <p class="game-subtitle">A Full-Featured RuneScape-Style MMORPG</p>
            
            <div id="authContainer">
                <div id="loginForm">
                    <h2>Login to Play</h2>
                    <label for="loginEmail" class="sr-only">Email Address</label>
                    <input 
                        type="email" 
                        id="loginEmail" 
                        placeholder="Email" 
                        class="auth-input" 
                        autocomplete="email"
                        aria-label="Email address"
                        required
                        onkeypress="if(event.key==='Enter') loginUser()">
                    <label for="loginPassword" class="sr-only">Password</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        placeholder="Password" 
                        class="auth-input" 
                        autocomplete="current-password"
                        aria-label="Password"
                        required
                        onkeypress="if(event.key==='Enter') loginUser()">
                    <button onclick="loginUser()" class="auth-btn" aria-label="Login to game">Login</button>
                    <p class="auth-switch">Don't have an account? <a href="#" onclick="showRegister(); return false;" aria-label="Switch to registration form">Register</a></p>
                </div>

                <div id="registerForm" style="display: none;">
                    <h2>Create Account</h2>
                    <label for="registerUsername" class="sr-only">Username</label>
                    <input 
                        type="text" 
                        id="registerUsername" 
                        placeholder="Username" 
                        class="auth-input" 
                        maxlength="20"
                        aria-label="Choose a username"
                        required
                        onkeypress="if(event.key==='Enter') registerUser()">
                    <label for="registerEmail" class="sr-only">Email Address</label>
                    <input 
                        type="email" 
                        id="registerEmail" 
                        placeholder="Email" 
                        class="auth-input" 
                        autocomplete="email"
                        aria-label="Email address"
                        required
                        onkeypress="if(event.key==='Enter') registerUser()">
                    <label for="registerPassword" class="sr-only">Password</label>
                    <input 
                        type="password" 
                        id="registerPassword" 
                        placeholder="Password (min 6 characters)" 
                        class="auth-input" 
                        autocomplete="new-password"
                        aria-label="Choose a password (minimum 6 characters)"
                        required
                        minlength="6"
                        onkeypress="if(event.key==='Enter') registerUser()">
                    <button onclick="registerUser()" class="auth-btn" aria-label="Create new account">Create Account</button>
                    <p class="auth-switch">Already have an account? <a href="#" onclick="showLogin(); return false;" aria-label="Switch to login form">Login</a></p>
                </div>

                <div id="authMessage" class="auth-message" role="alert" aria-live="polite"></div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #5d4037;">
                <button onclick="startDemoMode()" class="auth-btn" style="background: #2196F3; border-color: #1976D2;">
                    üéÆ Play Demo Mode
                </button>
                <p style="text-align: center; font-size: 12px; color: #888; margin-top: 8px;">
                    No account needed - start playing immediately!
                </p>
            </div>
            
            <p class="auth-footer">Play a complete RuneScape-style adventure with 15 skills, quests, and more!</p>
        </div>
    </div>

    <!-- Main Game Container -->
    <div id="gameContainer" class="game-container" style="display: none;">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-left">
                <div class="game-title">‚öîÔ∏è MyScape Enhanced</div>
                <div class="player-info">
                    <span id="playerNameDisplay">Player</span>
                    <span class="separator">|</span>
                    <span id="combatLevelDisplay">Combat Lvl: 3</span>
                    <span class="separator">|</span>
                    <span id="totalLevelDisplay">Total Lvl: 32</span>
                </div>
            </div>
            <div class="top-bar-right">
                <button class="top-btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
                <button class="top-btn logout" onclick="logoutUser()">üö™ Logout</button>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="main-game-area">
            <!-- Left Sidebar - Skills & Inventory -->
            <div class="left-sidebar">
                <!-- Skills Panel -->
                <div class="panel skills-panel">
                    <div class="panel-header">üìä Skills</div>
                    <div class="skills-grid" id="skillsGrid">
                        <!-- Skills will be dynamically populated -->
                    </div>
                </div>

                <!-- Inventory Panel -->
                <div class="panel inventory-panel">
                    <div class="panel-header">üéí Inventory</div>
                    <div class="inventory-grid" id="inventoryGrid">
                        <!-- 28 inventory slots -->
                    </div>
                </div>
            </div>

            <!-- Center - Game Canvas -->
            <div class="game-canvas-wrapper">
                <canvas id="gameCanvas"></canvas>
                
                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="loading-overlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading MyScape...</div>
                </div>
            </div>

            <!-- Right Sidebar - Chat & Actions -->
            <div class="right-sidebar">
                <!-- Quick Actions -->
                <div class="panel actions-panel">
                    <div class="panel-header">‚ö° Quick Actions</div>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="openEquipment()">‚öîÔ∏è Equipment</button>
                        <button class="action-btn" onclick="openBank()">üè¶ Bank</button>
                        <button class="action-btn" onclick="openQuests()">üìú Quests</button>
                        <button class="action-btn" onclick="openShop()">üè™ Shop</button>
                    </div>
                </div>

                <!-- Chat Panel -->
                <div class="panel chat-panel">
                    <div class="panel-header">üí¨ Chat</div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-msg system">Welcome to MyScape Enhanced!</div>
                        <div class="chat-msg system">Right-click entities to interact.</div>
                        <div class="chat-msg system">Use WASD or click to move.</div>
                    </div>
                    <input type="text" id="chatInput" class="chat-input" placeholder="Type message..." maxlength="200">
                </div>

                <!-- System Messages -->
                <div class="panel system-panel">
                    <div class="panel-header">üì¢ System</div>
                    <div class="system-messages" id="systemMessages">
                        <!-- System messages will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu (Right-click) -->
    <div id="contextMenu" class="context-menu hidden"></div>

    <!-- Modal Panels (Equipment, Bank, etc.) -->
    <div id="modalOverlay" class="modal-overlay hidden"></div>

    <!-- Equipment Panel Modal -->
    <div id="equipmentModal" class="modal-panel hidden">
        <div class="modal-content equipment-modal">
            <div class="modal-header">
                <h2>‚öîÔ∏è Equipment</h2>
                <button class="modal-close" onclick="closeEquipment()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="equipment-layout">
                    <!-- Equipment Slots -->
                    <div class="equipment-slots">
                        <div class="equipment-row">
                            <div class="equipment-slot" id="slot-cape" data-slot="cape">
                                <div class="slot-icon">üß•</div>
                                <div class="slot-label">Cape</div>
                            </div>
                            <div class="equipment-slot" id="slot-head" data-slot="head">
                                <div class="slot-icon">‚õëÔ∏è</div>
                                <div class="slot-label">Head</div>
                            </div>
                            <div class="equipment-slot" id="slot-amulet" data-slot="amulet">
                                <div class="slot-icon">üìø</div>
                                <div class="slot-label">Neck</div>
                            </div>
                        </div>
                        <div class="equipment-row">
                            <div class="equipment-slot" id="slot-weapon" data-slot="weapon">
                                <div class="slot-icon">üó°Ô∏è</div>
                                <div class="slot-label">Weapon</div>
                            </div>
                            <div class="equipment-slot" id="slot-body" data-slot="body">
                                <div class="slot-icon">ü¶∫</div>
                                <div class="slot-label">Body</div>
                            </div>
                            <div class="equipment-slot" id="slot-shield" data-slot="shield">
                                <div class="slot-icon">üõ°Ô∏è</div>
                                <div class="slot-label">Shield</div>
                            </div>
                        </div>
                        <div class="equipment-row">
                            <div class="equipment-slot" id="slot-gloves" data-slot="gloves">
                                <div class="slot-icon">üß§</div>
                                <div class="slot-label">Gloves</div>
                            </div>
                            <div class="equipment-slot" id="slot-legs" data-slot="legs">
                                <div class="slot-icon">üëñ</div>
                                <div class="slot-label">Legs</div>
                            </div>
                            <div class="equipment-slot" id="slot-ring" data-slot="ring">
                                <div class="slot-icon">üíç</div>
                                <div class="slot-label">Ring</div>
                            </div>
                        </div>
                        <div class="equipment-row">
                            <div class="equipment-slot" id="slot-boots" data-slot="boots">
                                <div class="slot-icon">üë¢</div>
                                <div class="slot-label">Boots</div>
                            </div>
                            <div class="equipment-slot" id="slot-ammo" data-slot="ammo">
                                <div class="slot-icon">üèπ</div>
                                <div class="slot-label">Ammo</div>
                            </div>
                            <div class="equipment-slot empty-slot"></div>
                        </div>
                    </div>

                    <!-- Equipment Stats -->
                    <div class="equipment-stats">
                        <h3>‚öîÔ∏è Combat Stats</h3>
                        <div class="stat-row">
                            <span class="stat-label">Attack (Slash):</span>
                            <span class="stat-value" id="stat-attackSlash">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Strength:</span>
                            <span class="stat-value" id="stat-meleeStrength">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Defence:</span>
                            <span class="stat-value" id="stat-defenceSlash">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Ranged:</span>
                            <span class="stat-value" id="stat-attackRanged">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Magic:</span>
                            <span class="stat-value" id="stat-attackMagic">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Prayer:</span>
                            <span class="stat-value" id="stat-prayer">+0</span>
                        </div>
                        <div class="equipment-hint">
                            üí° Click inventory items to equip<br>
                            Click equipped items to unequip
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bank Panel Modal -->
    <div id="bankModal" class="modal-panel hidden">
        <div class="modal-content bank-modal">
            <div class="modal-header">
                <h2>üè¶ Bank of RuneScape</h2>
                <button class="modal-close" onclick="closeBank()">‚úï</button>
            </div>
            <div class="modal-body bank-body">
                <!-- Bank Tabs -->
                <div class="bank-tabs" id="bankTabs">
                    <!-- Tabs will be generated dynamically -->
                </div>

                <!-- Bank Search and Info -->
                <div class="bank-controls">
                    <input type="text" id="bankSearch" class="bank-search" placeholder="üîç Search items..." />
                    <div class="bank-info">
                        <span id="bankItemCount">0/450</span>
                        <span class="bank-separator">|</span>
                        <span id="bankValue">Value: 0 gp</span>
                    </div>
                </div>

                <!-- Bank Slots Grid -->
                <div class="bank-slots-container">
                    <div class="bank-slots-grid" id="bankSlotsGrid">
                        <!-- 50 bank slots for current tab -->
                    </div>
                </div>

                <!-- Bank Actions -->
                <div class="bank-actions">
                    <div class="bank-action-group">
                        <button class="bank-btn" onclick="depositInventory()">üì• Deposit Inventory</button>
                        <button class="bank-btn" onclick="depositEquipment()">üì• Deposit Equipment</button>
                    </div>
                    <div class="bank-action-group">
                        <button class="bank-btn withdraw-btn" id="withdrawBtn" disabled>üì§ Withdraw</button>
                        <div class="withdraw-quantity">
                            <button class="qty-btn" onclick="setWithdrawQuantity(1)">1</button>
                            <button class="qty-btn" onclick="setWithdrawQuantity(5)">5</button>
                            <button class="qty-btn" onclick="setWithdrawQuantity(10)">10</button>
                            <button class="qty-btn" onclick="setWithdrawQuantity('all')">All</button>
                            <button class="qty-btn" onclick="setWithdrawQuantity('x')">X</button>
                        </div>
                    </div>
                </div>

                <!-- Bank Instructions -->
                <div class="bank-hint">
                    üí° Click inventory items to deposit | Click bank items to withdraw<br>
                    Right-click for quantity options | Use tabs to organize items
                </div>
            </div>
        </div>
    </div>

    <!-- Quest Panel Modal (PHASE 7) -->
    <div id="questModal" class="modal-panel hidden">
        <div class="modal-content quest-modal">
            <div class="modal-header">
                <h2>üìú Quest Journal</h2>
                <button class="modal-close" onclick="closeQuests()">‚úï</button>
            </div>
            <div class="modal-body quest-body">
                <!-- Quest Summary -->
                <div class="quest-summary">
                    <div class="quest-stat">
                        <span class="quest-stat-label">Quest Points:</span>
                        <span class="quest-stat-value" id="questPointsDisplay">0</span>
                    </div>
                    <div class="quest-stat">
                        <span class="quest-stat-label">Completed:</span>
                        <span class="quest-stat-value" id="completedQuestsDisplay">0/3</span>
                    </div>
                </div>

                <!-- Quest Tabs -->
                <div class="quest-tabs">
                    <button class="quest-tab active" onclick="switchQuestTab('active')" id="tab-active">
                        Active (<span id="activeQuestCount">0</span>)
                    </button>
                    <button class="quest-tab" onclick="switchQuestTab('available')" id="tab-available">
                        Available (<span id="availableQuestCount">0</span>)
                    </button>
                    <button class="quest-tab" onclick="switchQuestTab('completed')" id="tab-completed">
                        Completed (<span id="completedQuestCount">0</span>)
                    </button>
                </div>

                <!-- Quest List -->
                <div class="quest-list" id="questList">
                    <!-- Quests will be populated dynamically -->
                </div>

                <!-- Quest Details Panel -->
                <div class="quest-details" id="questDetails">
                    <div class="no-quest-selected">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìú</div>
                        <div>Select a quest to view details</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Game Configuration -->
    <script src="data/game-config.js"></script>

    <!-- Core Engine Files -->
    <script src="js/core/Camera.js"></script>
    <script src="js/core/Renderer.js"></script>
    <script src="js/core/InputHandler.js"></script>
    
    <!-- Entity Classes -->
    <script src="js/entities/Player.js"></script>
    <script src="js/entities/Resource.js"></script>
    <script src="js/entities/Enemy.js"></script>
    
    <!-- Game Systems -->
    <script src="js/systems/SkillsSystem.js"></script>
    <script src="js/systems/InventorySystem.js"></script>
    <script src="js/systems/WorldSystem.js"></script>
    <script src="js/systems/CombatSystem.js"></script>
    <script src="js/systems/DamageNumbersSystem.js"></script>
    <script src="js/systems/EquipmentSystem.js"></script>
    <script src="js/systems/BankingSystem.js"></script>
    <script src="js/systems/NPCSystem.js"></script>
    <script src="js/systems/QuestSystem.js"></script>
    
    <!-- UI Components -->
    <script src="js/ui/UIManager.js"></script>
    <script src="js/ui/StatsPanel.js"></script>
    <script src="js/ui/ContextMenu.js"></script>
    
    <!-- Performance & Utility Systems (Phase 8) -->
    <script src="js/utils/SpatialGrid.js"></script>
    <script src="js/utils/ObjectPool.js"></script>
    <script src="js/utils/PathFinding.js"></script>
    
    <!-- Main Game Engine (must load last) -->
    <script src="js/core/GameEngine.js"></script>

    <!-- Firebase Authentication & Game Initialization -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqMqav_HFKid6XdmbnfhG5llgCMZoYQV0",
            authDomain: "fantasyquest-mmorpg.firebaseapp.com",
            databaseURL: "https://fantasyquest-mmorpg-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fantasyquest-mmorpg",
            storageBucket: "fantasyquest-mmorpg.firebasestorage.app",
            messagingSenderId: "149888279159",
            appId: "1:149888279159:web:48a53797f0c57f3a671c72",
            measurementId: "G-4R4YVKSRSE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let gameEngine = null;

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                showGame();
                initializeGame();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        function showGame() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            if (currentUser) {
                document.getElementById('playerNameDisplay').textContent = 
                    currentUser.displayName || currentUser.email.split('@')[0];
            } else {
                document.getElementById('playerNameDisplay').textContent = 'Demo Player';
            }
        }
        
        // Demo Mode - Bypass authentication for testing
        function startDemoMode() {
            console.log('üéÆ Starting Demo Mode...');
            
            // Create a fake demo user object
            currentUser = {
                uid: 'demo-user',
                email: 'demo@myscape.game',
                displayName: 'Demo Player',
                isDemo: true
            };
            
            // Show game and initialize
            showGame();
            initializeGame();
        }

        function showAuthMessage(message, isError = false) {
            const msgEl = document.getElementById('authMessage');
            msgEl.textContent = message;
            msgEl.style.color = isError ? '#e74c3c' : '#2ecc71';
            msgEl.style.display = 'block';
            setTimeout(() => {
                msgEl.style.display = 'none';
            }, 5000);
        }

        async function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAuthMessage('Please enter email and password', true);
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showAuthMessage('Login successful!');
            } catch (error) {
                console.error('Login error:', error);
                showAuthMessage(error.message, true);
            }
        }

        async function registerUser() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!username || !email || !password) {
                showAuthMessage('Please fill all fields', true);
                return;
            }

            if (password.length < 6) {
                showAuthMessage('Password must be at least 6 characters', true);
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Update display name
                await user.updateProfile({ displayName: username });
                
                // Save initial player data
                await database.ref(`myscape-players/${user.uid}`).set({
                    username: username,
                    email: email,
                    createdAt: Date.now(),
                    totalLevel: 32,
                    combatLevel: 3
                });

                showAuthMessage('Account created successfully!');
            } catch (error) {
                console.error('Registration error:', error);
                showAuthMessage(error.message, true);
            }
        }

        async function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    // Save game state before logout
                    if (gameEngine) {
                        await saveGameState();
                    }
                    
                    // Handle demo mode logout
                    if (currentUser && currentUser.isDemo) {
                        currentUser = null;
                        gameEngine = null;
                        showLogin();
                        location.reload(); // Reload to reset game state
                        return;
                    }
                    
                    await auth.signOut();
                    showAuthMessage('Logged out successfully');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
        }

        async function initializeGame() {
            // ‚úÖ MEDIUM PRIORITY FIX: Improved loading states with real progress
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.querySelector('.loading-text');
            
            try {
                console.log('üéÆ Initializing game...');
                
                loadingText.textContent = 'Initializing game engine...';
                
                // Create game engine
                gameEngine = new GameEngine();
                window.gameEngine = gameEngine; // Make globally accessible
                
                loadingText.textContent = 'Loading game systems...';
                
                // Initialize the engine
                await gameEngine.init('gameCanvas');
                
                loadingText.textContent = 'Loading player data...';
                
                // Load player data from Firebase
                await loadPlayerData();
                
                loadingText.textContent = 'Starting game...';
                
                // Wait a brief moment for final initialization
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // ‚úÖ Hide loading overlay after ACTUAL loading completes
                loadingOverlay.style.display = 'none';
                
                console.log('‚úÖ Game initialized successfully!');
                
                addSystemMessage('Game loaded successfully!');
                addSystemMessage('Welcome back, ' + (currentUser.displayName || 'Player') + '!');
                
            } catch (error) {
                console.error('Failed to initialize game:', error);
                loadingText.textContent = 'Error loading game';
                loadingText.style.color = '#f44336';
                
                // Show error message after a moment
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    alert('Failed to start game: ' + error.message);
                }, 2000);
            }
        }

        async function loadPlayerData() {
            if (!currentUser) return;
            
            // Skip Firebase for demo mode
            if (currentUser.isDemo) {
                console.log('üì¶ Demo mode - skipping player data load');
                return;
            }
            
            try {
                const snapshot = await database.ref(`myscape-players/${currentUser.uid}`).once('value');
                const data = snapshot.val();
                
                if (data) {
                    console.log('üì¶ Player data loaded:', data);
                    // Player data will be used when systems are implemented
                }
            } catch (error) {
                console.error('Error loading player data:', error);
            }
        }

        async function saveGameState() {
            if (!currentUser || !gameEngine) return;
            
            // Skip Firebase for demo mode
            if (currentUser.isDemo) {
                console.log('üíæ Demo mode - game state not saved to cloud');
                return;
            }
            
            try {
                // Save game state to Firebase
                await database.ref(`myscape-players/${currentUser.uid}/lastSave`).set({
                    timestamp: Date.now(),
                    position: {
                        x: gameEngine.player.x,
                        y: gameEngine.player.y
                    }
                });
                
                console.log('üíæ Game state saved');
            } catch (error) {
                console.error('Error saving game state:', error);
            }
        }

        // Auto-save every 60 seconds
        setInterval(() => {
            if (currentUser && gameEngine) {
                saveGameState();
            }
        }, 60000);

        // Save on page unload
        window.addEventListener('beforeunload', () => {
            if (currentUser && gameEngine) {
                saveGameState();
            }
        });

        // Chat input handler
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && chatInput.value.trim()) {
                        addChatMessage(chatInput.value, 'player');
                        chatInput.value = '';
                    }
                });
            }
            
            // Setup equipment panel listeners
            setupEquipmentListeners();
            
            // Setup bank panel listeners
            const bankSearch = document.getElementById('bankSearch');
            if (bankSearch) {
                bankSearch.addEventListener('input', (e) => {
                    // TODO: Implement bank search filter
                    console.log('Bank search:', e.target.value);
                });
            }
            
            const withdrawBtn = document.getElementById('withdrawBtn');
            if (withdrawBtn) {
                withdrawBtn.addEventListener('click', withdrawFromBank);
            }
            
            // Close modals when clicking overlay
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.addEventListener('click', () => {
                    closeEquipment();
                    closeBank();
                });
            }
        });

        function addChatMessage(message, type = 'system') {
            const chatMessages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-msg ${type}`;
            msgDiv.textContent = message;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Limit messages
            while (chatMessages.children.length > 100) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
        }

        function addSystemMessage(message) {
            const systemMessages = document.getElementById('systemMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'system-msg';
            msgDiv.textContent = message;
            systemMessages.appendChild(msgDiv);
            systemMessages.scrollTop = systemMessages.scrollHeight;
            
            // Limit messages
            while (systemMessages.children.length > 50) {
                systemMessages.removeChild(systemMessages.firstChild);
            }
        }

        // Placeholder functions for Phase 6+
        function openEquipment() {
            const modal = document.getElementById('equipmentModal');
            const overlay = document.getElementById('modalOverlay');
            
            modal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            
            // Update equipment display
            updateEquipmentDisplay();
            
            addSystemMessage('Equipment panel opened');
        }

        function closeEquipment() {
            const modal = document.getElementById('equipmentModal');
            const overlay = document.getElementById('modalOverlay');
            
            modal.classList.add('hidden');
            overlay.classList.add('hidden');
        }

        function updateEquipmentDisplay() {
            if (!window.gameEngine || !window.gameEngine.equipmentSystem) return;
            
            const equipmentSystem = window.gameEngine.equipmentSystem;
            const equipped = equipmentSystem.getAllEquipped();
            const bonuses = equipmentSystem.bonuses;
            
            // Update equipment slots
            for (const [slotName, item] of Object.entries(equipped)) {
                const slotElement = document.getElementById(`slot-${slotName}`);
                if (!slotElement) continue;
                
                if (item && item.data) {
                    // Show equipped item
                    slotElement.classList.add('equipped');
                    slotElement.innerHTML = `
                        <div class="equipped-item">
                            <span class="item-icon">${item.data.icon || '?'}</span>
                            <div class="item-name">${item.data.name}</div>
                        </div>
                    `;
                    slotElement.title = item.data.name;
                } else {
                    // Show empty slot
                    slotElement.classList.remove('equipped');
                    const icon = getSlotIcon(slotName);
                    const label = getSlotLabel(slotName);
                    slotElement.innerHTML = `
                        <div class="slot-icon">${icon}</div>
                        <div class="slot-label">${label}</div>
                    `;
                }
            }
            
            // Update stats
            updateStat('attackSlash', bonuses.attackSlash);
            updateStat('meleeStrength', bonuses.meleeStrength);
            updateStat('defenceSlash', bonuses.defenceSlash);
            updateStat('attackRanged', bonuses.attackRanged);
            updateStat('attackMagic', bonuses.attackMagic);
            updateStat('prayer', bonuses.prayer);
        }

        function updateStat(statName, value) {
            const element = document.getElementById(`stat-${statName}`);
            if (!element) return;
            
            element.textContent = value > 0 ? `+${value}` : `${value}`;
            element.className = 'stat-value';
            if (value > 0) element.classList.add('positive');
            else if (value < 0) element.classList.add('negative');
        }

        function getSlotIcon(slotName) {
            const icons = {
                head: '‚õëÔ∏è', cape: 'üß•', amulet: 'üìø', weapon: 'üó°Ô∏è',
                body: 'ü¶∫', shield: 'üõ°Ô∏è', legs: 'üëñ', gloves: 'üß§',
                boots: 'üë¢', ring: 'üíç', ammo: 'üèπ'
            };
            return icons[slotName] || '?';
        }

        function getSlotLabel(slotName) {
            const labels = {
                head: 'Head', cape: 'Cape', amulet: 'Neck', weapon: 'Weapon',
                body: 'Body', shield: 'Shield', legs: 'Legs', gloves: 'Gloves',
                boots: 'Boots', ring: 'Ring', ammo: 'Ammo'
            };
            return labels[slotName] || slotName;
        }

        // Add click listeners to equipment slots
        function setupEquipmentListeners() {
            const slots = document.querySelectorAll('.equipment-slot[data-slot]');
            slots.forEach(slot => {
                slot.addEventListener('click', function() {
                    const slotName = this.getAttribute('data-slot');
                    unequipItem(slotName);
                });
            });
        }

        function unequipItem(slotName) {
            if (!window.gameEngine || !window.gameEngine.equipmentSystem || !window.gameEngine.player) return;
            
            const result = window.gameEngine.equipmentSystem.unequipItem(window.gameEngine.player, slotName);
            
            if (result.success) {
                addSystemMessage(result.message);
                updateEquipmentDisplay();
                updateInventoryDisplay();
            } else {
                addSystemMessage(result.message, 'error');
            }
        }

        // ========== INVENTORY DISPLAY FUNCTIONS ==========
        
        function updateInventoryDisplay() {
            if (!window.gameEngine || !window.gameEngine.inventorySystem) return;
            
            const inventorySystem = window.gameEngine.inventorySystem;
            const inventoryGrid = document.getElementById('inventoryGrid');
            
            if (!inventoryGrid) return;
            
            // Clear existing slots
            inventoryGrid.innerHTML = '';
            
            // Create 28 inventory slots
            for (let i = 0; i < inventorySystem.maxSlots; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                slot.dataset.slot = i;
                
                const item = inventorySystem.getItemInSlot(i);
                
                if (item && item.itemId) {
                    const itemData = window.gameConfig.items[item.itemId];
                    if (itemData) {
                        slot.classList.add('has-item');
                        slot.innerHTML = `
                            <div class="inventory-item-icon">${itemData.icon || 'üì¶'}</div>
                            ${item.quantity > 1 ? `<div class="inventory-item-quantity">${item.quantity}</div>` : ''}
                        `;
                        slot.title = `${itemData.name} ${item.quantity > 1 ? '(' + item.quantity + ')' : ''}`;
                        
                        // Add click listener to equip or use item
                        slot.onclick = () => useInventoryItem(i);
                    }
                }
                
                inventoryGrid.appendChild(slot);
            }
        }
        
        function useInventoryItem(slotIndex) {
            if (!window.gameEngine) return;
            
            const inventorySystem = window.gameEngine.inventorySystem;
            const equipmentSystem = window.gameEngine.equipmentSystem;
            const player = window.gameEngine.player;
            
            const item = inventorySystem.getItemInSlot(slotIndex);
            if (!item) return;
            
            const itemData = window.gameConfig.items[item.itemId];
            if (!itemData) return;
            
            // Check if item is equippable
            if (itemData.slot && equipmentSystem) {
                const result = equipmentSystem.equipItem(player, slotIndex);
                
                if (result.success) {
                    addSystemMessage(result.message);
                    updateEquipmentDisplay();
                    updateInventoryDisplay();
                } else {
                    addSystemMessage(result.message, 'error');
                }
            } else if (itemData.heals) {
                // Food item - consume it
                // TODO: Implement food consumption
                addSystemMessage(`You eat the ${itemData.name}.`);
            } else {
                addSystemMessage(`You can't use ${itemData.name}.`);
            }
        }

        // ========== BANK PANEL FUNCTIONS (PHASE 6) ==========
        
        let selectedBankSlot = null;
        let withdrawQuantity = 1;
        
        function openBank() {
            if (!window.gameEngine || !window.gameEngine.bankingSystem) {
                addSystemMessage('Banking system not initialized!', 'error');
                return;
            }
            
            const modal = document.getElementById('bankModal');
            const overlay = document.getElementById('modalOverlay');
            
            modal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            
            // Initialize bank UI
            initializeBankTabs();
            updateBankDisplay();
            
            addSystemMessage('Bank opened');
        }
        
        function closeBank() {
            const modal = document.getElementById('bankModal');
            const overlay = document.getElementById('modalOverlay');
            
            modal.classList.add('hidden');
            overlay.classList.add('hidden');
            
            selectedBankSlot = null;
            
            // Update inventory display in case items were moved
            if (window.gameEngine && window.gameEngine.inventorySystem) {
                updateInventoryDisplay();
            }
        }
        
        function initializeBankTabs() {
            const bankingSystem = window.gameEngine.bankingSystem;
            const tabsContainer = document.getElementById('bankTabs');
            
            tabsContainer.innerHTML = '';
            
            bankingSystem.tabs.forEach((tab, index) => {
                const tabButton = document.createElement('div');
                tabButton.className = 'bank-tab' + (index === bankingSystem.currentTab ? ' active' : '');
                tabButton.innerHTML = `
                    <span class="tab-icon">${tab.icon}</span>
                    <span class="tab-number">${index + 1}</span>
                `;
                tabButton.title = tab.name;
                tabButton.onclick = () => switchBankTab(index);
                
                tabsContainer.appendChild(tabButton);
            });
        }
        
        function switchBankTab(tabIndex) {
            const bankingSystem = window.gameEngine.bankingSystem;
            
            bankingSystem.switchTab(tabIndex);
            
            // Update tab visuals
            const tabs = document.querySelectorAll('.bank-tab');
            tabs.forEach((tab, index) => {
                if (index === tabIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            updateBankDisplay();
        }
        
        function updateBankDisplay() {
            if (!window.gameEngine || !window.gameEngine.bankingSystem) return;
            
            const bankingSystem = window.gameEngine.bankingSystem;
            const currentTab = bankingSystem.tabs[bankingSystem.currentTab];
            const slotsGrid = document.getElementById('bankSlotsGrid');
            
            // Clear existing slots
            slotsGrid.innerHTML = '';
            
            // Create 50 slots for current tab
            for (let i = 0; i < bankingSystem.slotsPerTab; i++) {
                const slot = document.createElement('div');
                slot.className = 'bank-slot';
                slot.dataset.slot = i;
                
                // Find item in this slot
                const item = currentTab.items.find(item => item.slot === i);
                
                if (item && item.itemId) {
                    const itemData = window.gameConfig.items[item.itemId];
                    if (itemData) {
                        slot.classList.add('has-item');
                        slot.innerHTML = `
                            <div class="bank-item-icon">${itemData.icon || 'üì¶'}</div>
                            <div class="bank-item-quantity">${item.quantity}</div>
                        `;
                        slot.title = `${itemData.name} (${item.quantity})`;
                        
                        // Add click listener for withdrawal
                        slot.onclick = () => selectBankSlot(bankingSystem.currentTab, i);
                    }
                }
                
                slotsGrid.appendChild(slot);
            }
            
            // Update bank info
            updateBankInfo();
        }
        
        function updateBankInfo() {
            const bankingSystem = window.gameEngine.bankingSystem;
            
            // Count total items across all tabs
            let totalItems = 0;
            let totalValue = 0;
            
            bankingSystem.tabs.forEach(tab => {
                totalItems += tab.items.length;
                tab.items.forEach(item => {
                    const itemData = window.gameConfig.items[item.itemId];
                    if (itemData && itemData.value) {
                        totalValue += itemData.value * item.quantity;
                    }
                });
            });
            
            document.getElementById('bankItemCount').textContent = `${totalItems}/${bankingSystem.totalSlots}`;
            document.getElementById('bankValue').textContent = `Value: ${totalValue.toLocaleString()} gp`;
        }
        
        function selectBankSlot(tabIndex, slot) {
            selectedBankSlot = { tabIndex, slot };
            
            // Highlight selected slot
            const slots = document.querySelectorAll('.bank-slot');
            slots.forEach(s => s.classList.remove('selected'));
            
            const selectedElement = document.querySelector(`.bank-slot[data-slot="${slot}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
            }
            
            // Enable withdraw button
            document.getElementById('withdrawBtn').disabled = false;
        }
        
        function setWithdrawQuantity(qty) {
            if (qty === 'x') {
                const input = prompt('Enter quantity to withdraw:', '1');
                if (input) {
                    withdrawQuantity = parseInt(input) || 1;
                }
            } else if (qty === 'all') {
                withdrawQuantity = 'all';
            } else {
                withdrawQuantity = qty;
            }
            
            // Update button text
            const withdrawBtn = document.getElementById('withdrawBtn');
            withdrawBtn.textContent = `üì§ Withdraw ${withdrawQuantity === 'all' ? 'All' : withdrawQuantity}`;
        }
        
        function withdrawFromBank() {
            if (!selectedBankSlot) {
                addSystemMessage('Select an item to withdraw', 'error');
                return;
            }
            
            const bankingSystem = window.gameEngine.bankingSystem;
            const player = window.gameEngine.player;
            
            const result = bankingSystem.withdrawItem(
                player, 
                selectedBankSlot.tabIndex, 
                selectedBankSlot.slot, 
                withdrawQuantity
            );
            
            if (result.success) {
                addSystemMessage(result.message);
                updateBankDisplay();
                updateInventoryDisplay();
                selectedBankSlot = null;
                document.getElementById('withdrawBtn').disabled = true;
            } else {
                addSystemMessage(result.message, 'error');
            }
        }
        
        function depositInventory() {
            if (!window.gameEngine || !window.gameEngine.bankingSystem) return;
            
            const bankingSystem = window.gameEngine.bankingSystem;
            const inventorySystem = window.gameEngine.inventorySystem;
            const player = window.gameEngine.player;
            
            let deposited = 0;
            
            // Deposit all inventory items (iterate backwards to avoid index issues)
            for (let i = inventorySystem.maxSlots - 1; i >= 0; i--) {
                const item = inventorySystem.getItemInSlot(i);
                if (item) {
                    const result = bankingSystem.depositItem(player, i, item.quantity);
                    if (result.success) {
                        deposited++;
                    }
                }
            }
            
            if (deposited > 0) {
                addSystemMessage(`Deposited ${deposited} item(s) to bank`);
                updateBankDisplay();
                updateInventoryDisplay();
            } else {
                addSystemMessage('No items to deposit', 'error');
            }
        }
        
        function depositEquipment() {
            if (!window.gameEngine || !window.gameEngine.bankingSystem) return;
            
            const bankingSystem = window.gameEngine.bankingSystem;
            const equipmentSystem = window.gameEngine.equipmentSystem;
            const inventorySystem = window.gameEngine.inventorySystem;
            const player = window.gameEngine.player;
            
            let deposited = 0;
            
            // Get all equipped items
            const equipped = equipmentSystem.getAllEquipped();
            
            // First unequip all to inventory, then deposit
            for (const [slotName, item] of Object.entries(equipped)) {
                if (item && item.itemId) {
                    // Unequip to inventory
                    const unequipResult = equipmentSystem.unequipItem(player, slotName);
                    if (unequipResult.success) {
                        // Find the item in inventory (it was just added)
                        for (let i = 0; i < inventorySystem.maxSlots; i++) {
                            const invItem = inventorySystem.getItemInSlot(i);
                            if (invItem && invItem.itemId === item.itemId) {
                                // Deposit it to bank
                                const depositResult = bankingSystem.depositItem(player, i, invItem.quantity);
                                if (depositResult.success) {
                                    deposited++;
                                }
                                break;
                            }
                        }
                    }
                }
            }
            
            if (deposited > 0) {
                addSystemMessage(`Deposited ${deposited} equipped item(s) to bank`);
                updateBankDisplay();
                updateInventoryDisplay();
                updateEquipmentDisplay();
            } else {
                addSystemMessage('No equipment to deposit', 'error');
            }
        }

        // ==================== QUEST PANEL FUNCTIONS (PHASE 7) ====================
        
        let currentQuestTab = 'active'; // Track current tab: 'active', 'available', 'completed'
        let selectedQuestId = null; // Track selected quest for details panel
        
        function openQuests() {
            if (!gameEngine || !gameEngine.questSystem) {
                addSystemMessage('Quest system not initialized', 'error');
                return;
            }
            
            const modal = document.getElementById('questModal');
            modal.classList.remove('hidden');
            
            // Reset to active tab
            currentQuestTab = 'active';
            selectedQuestId = null;
            
            // Update quest display
            updateQuestDisplay();
            
            // Switch to active tab
            switchQuestTab('active');
        }
        
        function closeQuests() {
            const modal = document.getElementById('questModal');
            modal.classList.add('hidden');
            selectedQuestId = null;
        }
        
        function switchQuestTab(tabType) {
            if (!gameEngine || !gameEngine.questSystem) {
                return;
            }
            
            currentQuestTab = tabType;
            
            // Update tab button states
            const tabs = document.querySelectorAll('.quest-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabType}`).classList.add('active');
            
            // Update quest list based on tab
            updateQuestList(tabType);
            
            // Clear selection when switching tabs
            selectedQuestId = null;
            clearQuestDetails();
        }
        
        function updateQuestDisplay() {
            if (!gameEngine || !gameEngine.questSystem) {
                return;
            }
            
            const questSystem = gameEngine.questSystem;
            
            // Update quest points display
            document.getElementById('questPointsDisplay').textContent = questSystem.questPoints;
            
            // Update completed quests count
            const totalQuests = Object.keys(questSystem.gameConfig.quests).length;
            const completedCount = questSystem.completedQuests.size;
            document.getElementById('completedQuestsDisplay').textContent = `${completedCount}/${totalQuests}`;
            
            // Update tab counters
            const activeCount = questSystem.activeQuests.size;
            const availableCount = questSystem.getAvailableQuests().length;
            const completedCountDisplay = questSystem.completedQuests.size;
            
            document.getElementById('activeQuestCount').textContent = activeCount;
            document.getElementById('availableQuestCount').textContent = availableCount;
            document.getElementById('completedQuestCount').textContent = completedCountDisplay;
            
            // Update quest list for current tab
            updateQuestList(currentQuestTab);
        }
        
        function updateQuestList(tabType) {
            if (!gameEngine || !gameEngine.questSystem) {
                return;
            }
            
            const questSystem = gameEngine.questSystem;
            const questList = document.getElementById('questList');
            questList.innerHTML = '';
            
            let quests = [];
            
            if (tabType === 'active') {
                // Get active quests
                quests = Array.from(questSystem.activeQuests.values());
                
                if (quests.length === 0) {
                    questList.innerHTML = '<div class="no-quests">No active quests. Check the Available tab to start a new quest!</div>';
                    return;
                }
                
                // Render active quests
                quests.forEach(questState => {
                    const questConfig = questSystem.getQuestConfig(questState.questId);
                    const questItem = createQuestListItem(questState.questId, questConfig, questState);
                    questList.appendChild(questItem);
                });
                
            } else if (tabType === 'available') {
                // Get available quests
                const availableQuests = questSystem.getAvailableQuests();
                
                if (availableQuests.length === 0) {
                    questList.innerHTML = '<div class="no-quests">No quests available. Complete more quests or level up your skills!</div>';
                    return;
                }
                
                // Render available quests
                availableQuests.forEach(questId => {
                    const questConfig = questSystem.getQuestConfig(questId);
                    const questItem = createQuestListItem(questId, questConfig, null);
                    questList.appendChild(questItem);
                });
                
            } else if (tabType === 'completed') {
                // Get completed quests
                const completedQuestIds = Array.from(questSystem.completedQuests);
                
                if (completedQuestIds.length === 0) {
                    questList.innerHTML = '<div class="no-quests">No completed quests yet. Start your adventure!</div>';
                    return;
                }
                
                // Render completed quests
                completedQuestIds.forEach(questId => {
                    const questConfig = questSystem.getQuestConfig(questId);
                    const questItem = createQuestListItem(questId, questConfig, null, true);
                    questList.appendChild(questItem);
                });
            }
        }
        
        function createQuestListItem(questId, questConfig, questState = null, isCompleted = false) {
            const questItem = document.createElement('div');
            questItem.className = 'quest-item';
            
            if (selectedQuestId === questId) {
                questItem.classList.add('selected');
            }
            
            questItem.onclick = () => selectQuest(questId);
            
            // Quest header
            const header = document.createElement('div');
            header.className = 'quest-item-header';
            
            const name = document.createElement('div');
            name.className = 'quest-item-name';
            name.textContent = questConfig.name;
            header.appendChild(name);
            
            const difficulty = document.createElement('span');
            difficulty.className = `quest-difficulty ${questConfig.difficulty.toLowerCase()}`;
            difficulty.textContent = questConfig.difficulty;
            header.appendChild(difficulty);
            
            questItem.appendChild(header);
            
            // Quest status
            const status = document.createElement('div');
            status.className = 'quest-item-status';
            
            if (isCompleted) {
                status.innerHTML = '<span style="color: #4CAF50;">‚úì Completed</span>';
            } else if (questState) {
                const currentStageNum = questState.currentStage + 1;
                const totalStages = questConfig.stages.length;
                status.textContent = `Stage ${currentStageNum}/${totalStages}`;
            } else {
                status.textContent = 'Not Started';
            }
            
            questItem.appendChild(status);
            
            return questItem;
        }
        
        function selectQuest(questId) {
            if (!gameEngine || !gameEngine.questSystem) {
                return;
            }
            
            selectedQuestId = questId;
            
            // Update selected state in quest list
            const questItems = document.querySelectorAll('.quest-item');
            questItems.forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.quest-item').classList.add('selected');
            
            // Show quest details
            showQuestDetails(questId);
        }
        
        function showQuestDetails(questId) {
            if (!gameEngine || !gameEngine.questSystem) {
                return;
            }
            
            const questSystem = gameEngine.questSystem;
            const questConfig = questSystem.getQuestConfig(questId);
            const questState = questSystem.activeQuests.get(questId);
            const isCompleted = questSystem.completedQuests.has(questId);
            
            const detailsPanel = document.getElementById('questDetails');
            detailsPanel.innerHTML = '';
            
            // Quest header
            const header = document.createElement('div');
            header.className = 'quest-detail-header';
            
            const title = document.createElement('h3');
            title.textContent = questConfig.name;
            header.appendChild(title);
            
            const difficulty = document.createElement('span');
            difficulty.className = `quest-difficulty ${questConfig.difficulty.toLowerCase()}`;
            difficulty.textContent = questConfig.difficulty;
            header.appendChild(difficulty);
            
            detailsPanel.appendChild(header);
            
            // Quest description
            const description = document.createElement('p');
            description.className = 'quest-description';
            description.textContent = questConfig.description;
            detailsPanel.appendChild(description);
            
            // Requirements section
            if (questConfig.requirements && Object.keys(questConfig.requirements).length > 0) {
                const reqSection = document.createElement('div');
                reqSection.className = 'quest-requirements';
                reqSection.innerHTML = '<h4>Requirements:</h4>';
                
                const reqList = document.createElement('ul');
                for (const [skillId, level] of Object.entries(questConfig.requirements)) {
                    const reqItem = document.createElement('li');
                    const playerSkill = gameEngine.playerStats.skills[skillId];
                    const hasRequirement = playerSkill && playerSkill.level >= level;
                    
                    reqItem.innerHTML = `
                        <span style="color: ${hasRequirement ? '#4CAF50' : '#f44336'};">
                            ${hasRequirement ? '‚úì' : '‚úó'}
                        </span>
                        Level ${level} ${skillId.charAt(0).toUpperCase() + skillId.slice(1)}
                    `;
                    reqList.appendChild(reqItem);
                }
                reqSection.appendChild(reqList);
                detailsPanel.appendChild(reqSection);
            }
            
            // Stages section
            const stagesSection = document.createElement('div');
            stagesSection.className = 'quest-stages';
            stagesSection.innerHTML = '<h4>Quest Stages:</h4>';
            
            questConfig.stages.forEach((stage, index) => {
                const stageItem = document.createElement('div');
                stageItem.className = 'quest-stage-item';
                
                // Determine stage status
                if (isCompleted || (questState && index < questState.currentStage)) {
                    stageItem.classList.add('completed');
                } else if (questState && index === questState.currentStage) {
                    stageItem.classList.add('active');
                }
                
                const stageNumber = document.createElement('div');
                stageNumber.className = 'quest-stage-number';
                stageNumber.textContent = index + 1;
                stageItem.appendChild(stageNumber);
                
                const stageContent = document.createElement('div');
                stageContent.className = 'quest-stage-content';
                
                const stageDesc = document.createElement('div');
                stageDesc.className = 'quest-stage-description';
                stageDesc.textContent = stage.description;
                stageContent.appendChild(stageDesc);
                
                // Show progress if this is the active stage
                if (questState && index === questState.currentStage) {
                    const progress = questState.progress[index];
                    if (progress) {
                        const progressBar = document.createElement('div');
                        progressBar.className = 'quest-stage-progress';
                        
                        if (stage.type === 'gather' || stage.type === 'kill') {
                            const current = progress.current || 0;
                            const required = stage.amount || 1;
                            const percentage = Math.min(100, (current / required) * 100);
                            
                            progressBar.innerHTML = `
                                <div class="quest-progress-bar">
                                    <div class="quest-progress-fill" style="width: ${percentage}%"></div>
                                </div>
                                <div class="quest-progress-text">${current}/${required}</div>
                            `;
                        } else if (progress.completed) {
                            progressBar.innerHTML = '<span style="color: #4CAF50;">‚úì Completed</span>';
                        }
                        
                        stageContent.appendChild(progressBar);
                    }
                }
                
                stageItem.appendChild(stageContent);
                stagesSection.appendChild(stageItem);
            });
            
            detailsPanel.appendChild(stagesSection);
            
            // Rewards section
            const rewardsSection = document.createElement('div');
            rewardsSection.className = 'quest-rewards';
            rewardsSection.innerHTML = '<h4>Rewards:</h4>';
            
            const rewardGrid = document.createElement('div');
            rewardGrid.className = 'reward-grid';
            
            // XP rewards
            if (questConfig.rewards.xp) {
                for (const [skillId, xpAmount] of Object.entries(questConfig.rewards.xp)) {
                    const rewardItem = document.createElement('div');
                    rewardItem.className = 'reward-item';
                    rewardItem.innerHTML = `
                        <span class="reward-icon">‚ú®</span>
                        <span>${xpAmount} ${skillId.charAt(0).toUpperCase() + skillId.slice(1)} XP</span>
                    `;
                    rewardGrid.appendChild(rewardItem);
                }
            }
            
            // Item rewards
            if (questConfig.rewards.items) {
                questConfig.rewards.items.forEach(itemReward => {
                    const rewardItem = document.createElement('div');
                    rewardItem.className = 'reward-item';
                    rewardItem.innerHTML = `
                        <span class="reward-icon">üì¶</span>
                        <span>${itemReward.amount}x ${itemReward.item.replace(/_/g, ' ')}</span>
                    `;
                    rewardGrid.appendChild(rewardItem);
                });
            }
            
            // Coin rewards
            if (questConfig.rewards.coins) {
                const rewardItem = document.createElement('div');
                rewardItem.className = 'reward-item';
                rewardItem.innerHTML = `
                    <span class="reward-icon">üí∞</span>
                    <span>${questConfig.rewards.coins} coins</span>
                `;
                rewardGrid.appendChild(rewardItem);
            }
            
            // Quest points
            if (questConfig.rewards.questPoints) {
                const rewardItem = document.createElement('div');
                rewardItem.className = 'reward-item';
                rewardItem.innerHTML = `
                    <span class="reward-icon">‚≠ê</span>
                    <span>${questConfig.rewards.questPoints} Quest Points</span>
                `;
                rewardGrid.appendChild(rewardItem);
            }
            
            rewardsSection.appendChild(rewardGrid);
            detailsPanel.appendChild(rewardsSection);
            
            // Action buttons
            const actionButtons = document.createElement('div');
            actionButtons.className = 'quest-actions';
            
            if (isCompleted) {
                // Quest is completed - show completion message
                const completedMsg = document.createElement('div');
                completedMsg.className = 'quest-completed-message';
                completedMsg.innerHTML = '<span style="color: #4CAF50;">‚úì Quest Completed!</span>';
                actionButtons.appendChild(completedMsg);
            } else if (questState) {
                // Quest is in progress - show abandon button
                const abandonBtn = document.createElement('button');
                abandonBtn.className = 'rs-button button-danger';
                abandonBtn.textContent = 'Abandon Quest';
                abandonBtn.onclick = () => abandonQuest(questId);
                actionButtons.appendChild(abandonBtn);
            } else {
                // Quest is available - show start button
                const canStart = questSystem.canStartQuest(questId);
                
                const startBtn = document.createElement('button');
                startBtn.className = 'rs-button button-primary';
                startBtn.textContent = 'Start Quest';
                startBtn.disabled = !canStart.canStart;
                startBtn.onclick = () => startQuestFromUI(questId);
                actionButtons.appendChild(startBtn);
                
                if (!canStart.canStart) {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'quest-error';
                    errorMsg.textContent = canStart.reason;
                    actionButtons.appendChild(errorMsg);
                }
            }
            
            detailsPanel.appendChild(actionButtons);
        }
        
        function clearQuestDetails() {
            const detailsPanel = document.getElementById('questDetails');
            detailsPanel.innerHTML = `
                <div class="no-quest-selected">
                    <div style="font-size: 48px; margin-bottom: 16px;">üìú</div>
                    <div>Select a quest to view details</div>
                </div>
            `;
        }
        
        function startQuestFromUI(questId) {
            if (!gameEngine || !gameEngine.questSystem) {
                addSystemMessage('Quest system not available', 'error');
                return;
            }
            
            const result = gameEngine.questSystem.startQuest(questId);
            
            if (result.success) {
                addSystemMessage(`Started quest: ${result.questState.name}`);
                updateQuestDisplay();
                showQuestDetails(questId); // Refresh details
            } else {
                addSystemMessage(`Cannot start quest: ${result.reason}`, 'error');
            }
        }
        
        function abandonQuest(questId) {
            if (!gameEngine || !gameEngine.questSystem) {
                addSystemMessage('Quest system not available', 'error');
                return;
            }
            
            // Confirm abandonment
            if (!confirm('Are you sure you want to abandon this quest? Your progress will be lost.')) {
                return;
            }
            
            const questState = gameEngine.questSystem.activeQuests.get(questId);
            if (!questState) {
                addSystemMessage('Quest is not active', 'error');
                return;
            }
            
            // Remove quest from active quests
            gameEngine.questSystem.activeQuests.delete(questId);
            gameEngine.questSystem.questProgress.delete(questId);
            
            addSystemMessage(`Abandoned quest: ${questState.name}`, 'warning');
            
            // Update display
            updateQuestDisplay();
            clearQuestDetails();
            selectedQuestId = null;
        }
        
        // Event listener for quest system events
        if (gameEngine) {
            gameEngine.on('quest:started', (data) => {
                // Update quest display when a quest is started
                if (document.getElementById('questModal').classList.contains('hidden') === false) {
                    updateQuestDisplay();
                }
            });
            
            gameEngine.on('quest:progress', (data) => {
                // Update quest display when progress is made
                if (document.getElementById('questModal').classList.contains('hidden') === false) {
                    updateQuestDisplay();
                    if (selectedQuestId === data.questId) {
                        showQuestDetails(data.questId); // Refresh details if viewing this quest
                    }
                }
            });
            
            gameEngine.on('quest:stage_completed', (data) => {
                // Update quest display when a stage is completed
                if (document.getElementById('questModal').classList.contains('hidden') === false) {
                    updateQuestDisplay();
                    if (selectedQuestId === data.questId) {
                        showQuestDetails(data.questId);
                    }
                }
            });
            
            gameEngine.on('quest:completed', (data) => {
                // Update quest display when a quest is completed
                addSystemMessage(`Quest completed: ${data.questName}! +${data.rewards.questPoints || 0} Quest Points`, 'success');
                
                if (document.getElementById('questModal').classList.contains('hidden') === false) {
                    updateQuestDisplay();
                    if (selectedQuestId === data.questId) {
                        showQuestDetails(data.questId);
                    }
                }
            });
        }

        function openShop() {
            addSystemMessage('Shop system coming in Phase 6!');
        }

        function toggleSettings() {
            addSystemMessage('Settings panel coming soon!');
        }
    </script>
</body>
</html>
