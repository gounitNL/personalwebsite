<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyScape Enhanced - RuneScape-Style MMORPG</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h1 class="game-title-login">‚öîÔ∏è MyScape Enhanced</h1>
            <p class="game-subtitle">A Full-Featured RuneScape-Style MMORPG</p>
            
            <div id="authContainer">
                <div id="loginForm">
                    <h2>Login to Play</h2>
                    <input type="email" id="loginEmail" placeholder="Email" class="auth-input" autocomplete="email">
                    <input type="password" id="loginPassword" placeholder="Password" class="auth-input" autocomplete="current-password">
                    <button onclick="loginUser()" class="auth-btn">Login</button>
                    <p class="auth-switch">Don't have an account? <a href="#" onclick="showRegister(); return false;">Register</a></p>
                </div>

                <div id="registerForm" style="display: none;">
                    <h2>Create Account</h2>
                    <input type="text" id="registerUsername" placeholder="Username" class="auth-input" maxlength="20">
                    <input type="email" id="registerEmail" placeholder="Email" class="auth-input" autocomplete="email">
                    <input type="password" id="registerPassword" placeholder="Password (min 6 characters)" class="auth-input" autocomplete="new-password">
                    <button onclick="registerUser()" class="auth-btn">Create Account</button>
                    <p class="auth-switch">Already have an account? <a href="#" onclick="showLogin(); return false;">Login</a></p>
                </div>

                <div id="authMessage" class="auth-message"></div>
            </div>
            
            <p class="auth-footer">Play a complete RuneScape-style adventure with 15 skills, quests, and more!</p>
        </div>
    </div>

    <!-- Main Game Container -->
    <div id="gameContainer" class="game-container" style="display: none;">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="top-bar-left">
                <div class="game-title">‚öîÔ∏è MyScape Enhanced</div>
                <div class="player-info">
                    <span id="playerNameDisplay">Player</span>
                    <span class="separator">|</span>
                    <span id="combatLevelDisplay">Combat Lvl: 3</span>
                    <span class="separator">|</span>
                    <span id="totalLevelDisplay">Total Lvl: 32</span>
                </div>
            </div>
            <div class="top-bar-right">
                <button class="top-btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
                <button class="top-btn logout" onclick="logoutUser()">üö™ Logout</button>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="main-game-area">
            <!-- Left Sidebar - Skills & Inventory -->
            <div class="left-sidebar">
                <!-- Skills Panel -->
                <div class="panel skills-panel">
                    <div class="panel-header">üìä Skills</div>
                    <div class="skills-grid" id="skillsGrid">
                        <!-- Skills will be dynamically populated -->
                    </div>
                </div>

                <!-- Inventory Panel -->
                <div class="panel inventory-panel">
                    <div class="panel-header">üéí Inventory</div>
                    <div class="inventory-grid" id="inventoryGrid">
                        <!-- 28 inventory slots -->
                    </div>
                </div>
            </div>

            <!-- Center - Game Canvas -->
            <div class="game-canvas-wrapper">
                <canvas id="gameCanvas"></canvas>
                
                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="loading-overlay">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading MyScape...</div>
                </div>
            </div>

            <!-- Right Sidebar - Chat & Actions -->
            <div class="right-sidebar">
                <!-- Quick Actions -->
                <div class="panel actions-panel">
                    <div class="panel-header">‚ö° Quick Actions</div>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="openEquipment()">‚öîÔ∏è Equipment</button>
                        <button class="action-btn" onclick="openBank()">üè¶ Bank</button>
                        <button class="action-btn" onclick="openQuests()">üìú Quests</button>
                        <button class="action-btn" onclick="openShop()">üè™ Shop</button>
                    </div>
                </div>

                <!-- Chat Panel -->
                <div class="panel chat-panel">
                    <div class="panel-header">üí¨ Chat</div>
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-msg system">Welcome to MyScape Enhanced!</div>
                        <div class="chat-msg system">Right-click entities to interact.</div>
                        <div class="chat-msg system">Use WASD or click to move.</div>
                    </div>
                    <input type="text" id="chatInput" class="chat-input" placeholder="Type message..." maxlength="200">
                </div>

                <!-- System Messages -->
                <div class="panel system-panel">
                    <div class="panel-header">üì¢ System</div>
                    <div class="system-messages" id="systemMessages">
                        <!-- System messages will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu (Right-click) -->
    <div id="contextMenu" class="context-menu hidden"></div>

    <!-- Modal Panels (Equipment, Bank, etc.) -->
    <div id="modalOverlay" class="modal-overlay hidden"></div>

    <!-- Equipment Panel Modal -->
    <div id="equipmentModal" class="modal-panel hidden">
        <div class="modal-content equipment-modal">
            <div class="modal-header">
                <h2>‚öîÔ∏è Equipment</h2>
                <button class="modal-close" onclick="closeEquipment()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="equipment-layout">
                    <!-- Equipment Slots -->
                    <div class="equipment-slots">
                        <div class="equipment-row">
                            <div class="equipment-slot" id="slot-cape" data-slot="cape">
                                <div class="slot-icon">üß•</div>
                                <div class="slot-label">Cape</div>
                            </div>
                            <div class="equipment-slot" id="slot-head" data-slot="head">
                                <div class="slot-icon">‚õëÔ∏è</div>
                                <div class="slot-label">Head</div>
                            </div>
                            <div class="equipment-slot" id="slot-amulet" data-slot="amulet">
                                <div class="slot-icon">üìø</div>
                                <div class="slot-label">Neck</div>
                            </div>
                        </div>
                        <div class="equipment-row">
                            <div class="equipment-slot" id="slot-weapon" data-slot="weapon">
                                <div class="slot-icon">üó°Ô∏è</div>
                                <div class="slot-label">Weapon</div>
                            </div>
                            <div class="equipment-slot" id="slot-body" data-slot="body">
                                <div class="slot-icon">ü¶∫</div>
                                <div class="slot-label">Body</div>
                            </div>
                            <div class="equipment-slot" id="slot-shield" data-slot="shield">
                                <div class="slot-icon">üõ°Ô∏è</div>
                                <div class="slot-label">Shield</div>
                            </div>
                        </div>
                        <div class="equipment-row">
                            <div class="equipment-slot" id="slot-gloves" data-slot="gloves">
                                <div class="slot-icon">üß§</div>
                                <div class="slot-label">Gloves</div>
                            </div>
                            <div class="equipment-slot" id="slot-legs" data-slot="legs">
                                <div class="slot-icon">üëñ</div>
                                <div class="slot-label">Legs</div>
                            </div>
                            <div class="equipment-slot" id="slot-ring" data-slot="ring">
                                <div class="slot-icon">üíç</div>
                                <div class="slot-label">Ring</div>
                            </div>
                        </div>
                        <div class="equipment-row">
                            <div class="equipment-slot" id="slot-boots" data-slot="boots">
                                <div class="slot-icon">üë¢</div>
                                <div class="slot-label">Boots</div>
                            </div>
                            <div class="equipment-slot" id="slot-ammo" data-slot="ammo">
                                <div class="slot-icon">üèπ</div>
                                <div class="slot-label">Ammo</div>
                            </div>
                            <div class="equipment-slot empty-slot"></div>
                        </div>
                    </div>

                    <!-- Equipment Stats -->
                    <div class="equipment-stats">
                        <h3>‚öîÔ∏è Combat Stats</h3>
                        <div class="stat-row">
                            <span class="stat-label">Attack (Slash):</span>
                            <span class="stat-value" id="stat-attackSlash">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Strength:</span>
                            <span class="stat-value" id="stat-meleeStrength">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Defence:</span>
                            <span class="stat-value" id="stat-defenceSlash">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Ranged:</span>
                            <span class="stat-value" id="stat-attackRanged">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Magic:</span>
                            <span class="stat-value" id="stat-attackMagic">+0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Prayer:</span>
                            <span class="stat-value" id="stat-prayer">+0</span>
                        </div>
                        <div class="equipment-hint">
                            üí° Click inventory items to equip<br>
                            Click equipped items to unequip
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bank Panel Modal -->
    <div id="bankModal" class="modal-panel hidden">
        <div class="modal-content bank-modal">
            <div class="modal-header">
                <h2>üè¶ Bank of RuneScape</h2>
                <button class="modal-close" onclick="closeBank()">‚úï</button>
            </div>
            <div class="modal-body bank-body">
                <!-- Bank Tabs -->
                <div class="bank-tabs" id="bankTabs">
                    <!-- Tabs will be generated dynamically -->
                </div>

                <!-- Bank Search and Info -->
                <div class="bank-controls">
                    <input type="text" id="bankSearch" class="bank-search" placeholder="üîç Search items..." />
                    <div class="bank-info">
                        <span id="bankItemCount">0/450</span>
                        <span class="bank-separator">|</span>
                        <span id="bankValue">Value: 0 gp</span>
                    </div>
                </div>

                <!-- Bank Slots Grid -->
                <div class="bank-slots-container">
                    <div class="bank-slots-grid" id="bankSlotsGrid">
                        <!-- 50 bank slots for current tab -->
                    </div>
                </div>

                <!-- Bank Actions -->
                <div class="bank-actions">
                    <div class="bank-action-group">
                        <button class="bank-btn" onclick="depositInventory()">üì• Deposit Inventory</button>
                        <button class="bank-btn" onclick="depositEquipment()">üì• Deposit Equipment</button>
                    </div>
                    <div class="bank-action-group">
                        <button class="bank-btn withdraw-btn" id="withdrawBtn" disabled>üì§ Withdraw</button>
                        <div class="withdraw-quantity">
                            <button class="qty-btn" onclick="setWithdrawQuantity(1)">1</button>
                            <button class="qty-btn" onclick="setWithdrawQuantity(5)">5</button>
                            <button class="qty-btn" onclick="setWithdrawQuantity(10)">10</button>
                            <button class="qty-btn" onclick="setWithdrawQuantity('all')">All</button>
                            <button class="qty-btn" onclick="setWithdrawQuantity('x')">X</button>
                        </div>
                    </div>
                </div>

                <!-- Bank Instructions -->
                <div class="bank-hint">
                    üí° Click inventory items to deposit | Click bank items to withdraw<br>
                    Right-click for quantity options | Use tabs to organize items
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Game Configuration -->
    <script src="data/game-config.js"></script>

    <!-- Core Engine Files -->
    <script src="js/core/Camera.js"></script>
    <script src="js/core/Renderer.js"></script>
    <script src="js/core/InputHandler.js"></script>
    
    <!-- Entity Classes -->
    <script src="js/entities/Player.js"></script>
    <script src="js/entities/Resource.js"></script>
    <script src="js/entities/Enemy.js"></script>
    
    <!-- Game Systems -->
    <script src="js/systems/SkillsSystem.js"></script>
    <script src="js/systems/InventorySystem.js"></script>
    <script src="js/systems/WorldSystem.js"></script>
    <script src="js/systems/CombatSystem.js"></script>
    <script src="js/systems/DamageNumbersSystem.js"></script>
    <script src="js/systems/EquipmentSystem.js"></script>
    <script src="js/systems/BankingSystem.js"></script>
    <script src="js/systems/NPCSystem.js"></script>
    
    <!-- UI Components -->
    <script src="js/ui/UIManager.js"></script>
    <script src="js/ui/StatsPanel.js"></script>
    
    <!-- Main Game Engine (must load last) -->
    <script src="js/core/GameEngine.js"></script>

    <!-- Firebase Authentication & Game Initialization -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqMqav_HFKid6XdmbnfhG5llgCMZoYQV0",
            authDomain: "fantasyquest-mmorpg.firebaseapp.com",
            databaseURL: "https://fantasyquest-mmorpg-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "fantasyquest-mmorpg",
            storageBucket: "fantasyquest-mmorpg.firebasestorage.app",
            messagingSenderId: "149888279159",
            appId: "1:149888279159:web:48a53797f0c57f3a671c72",
            measurementId: "G-4R4YVKSRSE"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let gameEngine = null;

        // Auth state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                showGame();
                initializeGame();
            } else {
                currentUser = null;
                showLogin();
            }
        });

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        function showGame() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            if (currentUser) {
                document.getElementById('playerNameDisplay').textContent = 
                    currentUser.displayName || currentUser.email.split('@')[0];
            }
        }

        function showAuthMessage(message, isError = false) {
            const msgEl = document.getElementById('authMessage');
            msgEl.textContent = message;
            msgEl.style.color = isError ? '#e74c3c' : '#2ecc71';
            msgEl.style.display = 'block';
            setTimeout(() => {
                msgEl.style.display = 'none';
            }, 5000);
        }

        async function loginUser() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAuthMessage('Please enter email and password', true);
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showAuthMessage('Login successful!');
            } catch (error) {
                console.error('Login error:', error);
                showAuthMessage(error.message, true);
            }
        }

        async function registerUser() {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;

            if (!username || !email || !password) {
                showAuthMessage('Please fill all fields', true);
                return;
            }

            if (password.length < 6) {
                showAuthMessage('Password must be at least 6 characters', true);
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Update display name
                await user.updateProfile({ displayName: username });
                
                // Save initial player data
                await database.ref(`myscape-players/${user.uid}`).set({
                    username: username,
                    email: email,
                    createdAt: Date.now(),
                    totalLevel: 32,
                    combatLevel: 3
                });

                showAuthMessage('Account created successfully!');
            } catch (error) {
                console.error('Registration error:', error);
                showAuthMessage(error.message, true);
            }
        }

        async function logoutUser() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    // Save game state before logout
                    if (gameEngine) {
                        await saveGameState();
                    }
                    await auth.signOut();
                    showAuthMessage('Logged out successfully');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
        }

        async function initializeGame() {
            try {
                console.log('üéÆ Initializing game...');
                
                // Hide loading overlay after a short delay
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 1000);
                
                // Create game engine
                gameEngine = new GameEngine();
                window.gameEngine = gameEngine; // Make globally accessible
                
                // Initialize the engine
                await gameEngine.init('gameCanvas');
                
                // Load player data from Firebase
                await loadPlayerData();
                
                console.log('‚úÖ Game initialized successfully!');
                
                addSystemMessage('Game loaded successfully!');
                addSystemMessage('Welcome back, ' + (currentUser.displayName || 'Player') + '!');
                
            } catch (error) {
                console.error('Failed to initialize game:', error);
                alert('Failed to start game: ' + error.message);
            }
        }

        async function loadPlayerData() {
            if (!currentUser) return;
            
            try {
                const snapshot = await database.ref(`myscape-players/${currentUser.uid}`).once('value');
                const data = snapshot.val();
                
                if (data) {
                    console.log('üì¶ Player data loaded:', data);
                    // Player data will be used when systems are implemented
                }
            } catch (error) {
                console.error('Error loading player data:', error);
            }
        }

        async function saveGameState() {
            if (!currentUser || !gameEngine) return;
            
            try {
                // Save game state to Firebase
                await database.ref(`myscape-players/${currentUser.uid}/lastSave`).set({
                    timestamp: Date.now(),
                    position: {
                        x: gameEngine.player.x,
                        y: gameEngine.player.y
                    }
                });
                
                console.log('üíæ Game state saved');
            } catch (error) {
                console.error('Error saving game state:', error);
            }
        }

        // Auto-save every 60 seconds
        setInterval(() => {
            if (currentUser && gameEngine) {
                saveGameState();
            }
        }, 60000);

        // Save on page unload
        window.addEventListener('beforeunload', () => {
            if (currentUser && gameEngine) {
                saveGameState();
            }
        });

        // Chat input handler
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && chatInput.value.trim()) {
                        addChatMessage(chatInput.value, 'player');
                        chatInput.value = '';
                    }
                });
            }
            
            // Setup equipment panel listeners
            setupEquipmentListeners();
            
            // Setup bank panel listeners
            const bankSearch = document.getElementById('bankSearch');
            if (bankSearch) {
                bankSearch.addEventListener('input', (e) => {
                    // TODO: Implement bank search filter
                    console.log('Bank search:', e.target.value);
                });
            }
            
            const withdrawBtn = document.getElementById('withdrawBtn');
            if (withdrawBtn) {
                withdrawBtn.addEventListener('click', withdrawFromBank);
            }
            
            // Close modals when clicking overlay
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.addEventListener('click', () => {
                    closeEquipment();
                    closeBank();
                });
            }
        });

        function addChatMessage(message, type = 'system') {
            const chatMessages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-msg ${type}`;
            msgDiv.textContent = message;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Limit messages
            while (chatMessages.children.length > 100) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
        }

        function addSystemMessage(message) {
            const systemMessages = document.getElementById('systemMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'system-msg';
            msgDiv.textContent = message;
            systemMessages.appendChild(msgDiv);
            systemMessages.scrollTop = systemMessages.scrollHeight;
            
            // Limit messages
            while (systemMessages.children.length > 50) {
                systemMessages.removeChild(systemMessages.firstChild);
            }
        }

        // Placeholder functions for Phase 6+
        function openEquipment() {
            const modal = document.getElementById('equipmentModal');
            const overlay = document.getElementById('modalOverlay');
            
            modal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            
            // Update equipment display
            updateEquipmentDisplay();
            
            addSystemMessage('Equipment panel opened');
        }

        function closeEquipment() {
            const modal = document.getElementById('equipmentModal');
            const overlay = document.getElementById('modalOverlay');
            
            modal.classList.add('hidden');
            overlay.classList.add('hidden');
        }

        function updateEquipmentDisplay() {
            if (!window.game || !window.game.equipmentSystem) return;
            
            const equipmentSystem = window.game.equipmentSystem;
            const equipped = equipmentSystem.getAllEquipped();
            const bonuses = equipmentSystem.bonuses;
            
            // Update equipment slots
            for (const [slotName, item] of Object.entries(equipped)) {
                const slotElement = document.getElementById(`slot-${slotName}`);
                if (!slotElement) continue;
                
                if (item && item.data) {
                    // Show equipped item
                    slotElement.classList.add('equipped');
                    slotElement.innerHTML = `
                        <div class="equipped-item">
                            <span class="item-icon">${item.data.icon || '?'}</span>
                            <div class="item-name">${item.data.name}</div>
                        </div>
                    `;
                    slotElement.title = item.data.name;
                } else {
                    // Show empty slot
                    slotElement.classList.remove('equipped');
                    const icon = getSlotIcon(slotName);
                    const label = getSlotLabel(slotName);
                    slotElement.innerHTML = `
                        <div class="slot-icon">${icon}</div>
                        <div class="slot-label">${label}</div>
                    `;
                }
            }
            
            // Update stats
            updateStat('attackSlash', bonuses.attackSlash);
            updateStat('meleeStrength', bonuses.meleeStrength);
            updateStat('defenceSlash', bonuses.defenceSlash);
            updateStat('attackRanged', bonuses.attackRanged);
            updateStat('attackMagic', bonuses.attackMagic);
            updateStat('prayer', bonuses.prayer);
        }

        function updateStat(statName, value) {
            const element = document.getElementById(`stat-${statName}`);
            if (!element) return;
            
            element.textContent = value > 0 ? `+${value}` : `${value}`;
            element.className = 'stat-value';
            if (value > 0) element.classList.add('positive');
            else if (value < 0) element.classList.add('negative');
        }

        function getSlotIcon(slotName) {
            const icons = {
                head: '‚õëÔ∏è', cape: 'üß•', amulet: 'üìø', weapon: 'üó°Ô∏è',
                body: 'ü¶∫', shield: 'üõ°Ô∏è', legs: 'üëñ', gloves: 'üß§',
                boots: 'üë¢', ring: 'üíç', ammo: 'üèπ'
            };
            return icons[slotName] || '?';
        }

        function getSlotLabel(slotName) {
            const labels = {
                head: 'Head', cape: 'Cape', amulet: 'Neck', weapon: 'Weapon',
                body: 'Body', shield: 'Shield', legs: 'Legs', gloves: 'Gloves',
                boots: 'Boots', ring: 'Ring', ammo: 'Ammo'
            };
            return labels[slotName] || slotName;
        }

        // Add click listeners to equipment slots
        function setupEquipmentListeners() {
            const slots = document.querySelectorAll('.equipment-slot[data-slot]');
            slots.forEach(slot => {
                slot.addEventListener('click', function() {
                    const slotName = this.getAttribute('data-slot');
                    unequipItem(slotName);
                });
            });
        }

        function unequipItem(slotName) {
            if (!window.game || !window.game.equipmentSystem || !window.game.player) return;
            
            const result = window.game.equipmentSystem.unequipItem(window.game.player, slotName);
            
            if (result.success) {
                addSystemMessage(result.message);
                updateEquipmentDisplay();
                updateInventoryDisplay();
            } else {
                addSystemMessage(result.message, 'error');
            }
        }

        // ========== BANK PANEL FUNCTIONS (PHASE 6) ==========
        
        let selectedBankSlot = null;
        let withdrawQuantity = 1;
        
        function openBank() {
            if (!window.gameEngine || !window.gameEngine.bankingSystem) {
                addSystemMessage('Banking system not initialized!', 'error');
                return;
            }
            
            const modal = document.getElementById('bankModal');
            const overlay = document.getElementById('modalOverlay');
            
            modal.classList.remove('hidden');
            overlay.classList.remove('hidden');
            
            // Initialize bank UI
            initializeBankTabs();
            updateBankDisplay();
            
            addSystemMessage('Bank opened');
        }
        
        function closeBank() {
            const modal = document.getElementById('bankModal');
            const overlay = document.getElementById('modalOverlay');
            
            modal.classList.add('hidden');
            overlay.classList.add('hidden');
            
            selectedBankSlot = null;
            
            // Update inventory display in case items were moved
            if (window.gameEngine && window.gameEngine.inventorySystem) {
                updateInventoryDisplay();
            }
        }
        
        function initializeBankTabs() {
            const bankingSystem = window.gameEngine.bankingSystem;
            const tabsContainer = document.getElementById('bankTabs');
            
            tabsContainer.innerHTML = '';
            
            bankingSystem.tabs.forEach((tab, index) => {
                const tabButton = document.createElement('div');
                tabButton.className = 'bank-tab' + (index === bankingSystem.currentTab ? ' active' : '');
                tabButton.innerHTML = `
                    <span class="tab-icon">${tab.icon}</span>
                    <span class="tab-number">${index + 1}</span>
                `;
                tabButton.title = tab.name;
                tabButton.onclick = () => switchBankTab(index);
                
                tabsContainer.appendChild(tabButton);
            });
        }
        
        function switchBankTab(tabIndex) {
            const bankingSystem = window.gameEngine.bankingSystem;
            
            bankingSystem.switchTab(tabIndex);
            
            // Update tab visuals
            const tabs = document.querySelectorAll('.bank-tab');
            tabs.forEach((tab, index) => {
                if (index === tabIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            updateBankDisplay();
        }
        
        function updateBankDisplay() {
            if (!window.gameEngine || !window.gameEngine.bankingSystem) return;
            
            const bankingSystem = window.gameEngine.bankingSystem;
            const currentTab = bankingSystem.tabs[bankingSystem.currentTab];
            const slotsGrid = document.getElementById('bankSlotsGrid');
            
            // Clear existing slots
            slotsGrid.innerHTML = '';
            
            // Create 50 slots for current tab
            for (let i = 0; i < bankingSystem.slotsPerTab; i++) {
                const slot = document.createElement('div');
                slot.className = 'bank-slot';
                slot.dataset.slot = i;
                
                // Find item in this slot
                const item = currentTab.items.find(item => item.slot === i);
                
                if (item && item.itemId) {
                    const itemData = window.gameConfig.items[item.itemId];
                    if (itemData) {
                        slot.classList.add('has-item');
                        slot.innerHTML = `
                            <div class="bank-item-icon">${itemData.icon || 'üì¶'}</div>
                            <div class="bank-item-quantity">${item.quantity}</div>
                        `;
                        slot.title = `${itemData.name} (${item.quantity})`;
                        
                        // Add click listener for withdrawal
                        slot.onclick = () => selectBankSlot(bankingSystem.currentTab, i);
                    }
                }
                
                slotsGrid.appendChild(slot);
            }
            
            // Update bank info
            updateBankInfo();
        }
        
        function updateBankInfo() {
            const bankingSystem = window.gameEngine.bankingSystem;
            
            // Count total items across all tabs
            let totalItems = 0;
            let totalValue = 0;
            
            bankingSystem.tabs.forEach(tab => {
                totalItems += tab.items.length;
                tab.items.forEach(item => {
                    const itemData = window.gameConfig.items[item.itemId];
                    if (itemData && itemData.value) {
                        totalValue += itemData.value * item.quantity;
                    }
                });
            });
            
            document.getElementById('bankItemCount').textContent = `${totalItems}/${bankingSystem.totalSlots}`;
            document.getElementById('bankValue').textContent = `Value: ${totalValue.toLocaleString()} gp`;
        }
        
        function selectBankSlot(tabIndex, slot) {
            selectedBankSlot = { tabIndex, slot };
            
            // Highlight selected slot
            const slots = document.querySelectorAll('.bank-slot');
            slots.forEach(s => s.classList.remove('selected'));
            
            const selectedElement = document.querySelector(`.bank-slot[data-slot="${slot}"]`);
            if (selectedElement) {
                selectedElement.classList.add('selected');
            }
            
            // Enable withdraw button
            document.getElementById('withdrawBtn').disabled = false;
        }
        
        function setWithdrawQuantity(qty) {
            if (qty === 'x') {
                const input = prompt('Enter quantity to withdraw:', '1');
                if (input) {
                    withdrawQuantity = parseInt(input) || 1;
                }
            } else if (qty === 'all') {
                withdrawQuantity = 'all';
            } else {
                withdrawQuantity = qty;
            }
            
            // Update button text
            const withdrawBtn = document.getElementById('withdrawBtn');
            withdrawBtn.textContent = `üì§ Withdraw ${withdrawQuantity === 'all' ? 'All' : withdrawQuantity}`;
        }
        
        function withdrawFromBank() {
            if (!selectedBankSlot) {
                addSystemMessage('Select an item to withdraw', 'error');
                return;
            }
            
            const bankingSystem = window.gameEngine.bankingSystem;
            const player = window.gameEngine.player;
            
            const result = bankingSystem.withdrawItem(
                player, 
                selectedBankSlot.tabIndex, 
                selectedBankSlot.slot, 
                withdrawQuantity
            );
            
            if (result.success) {
                addSystemMessage(result.message);
                updateBankDisplay();
                updateInventoryDisplay();
                selectedBankSlot = null;
                document.getElementById('withdrawBtn').disabled = true;
            } else {
                addSystemMessage(result.message, 'error');
            }
        }
        
        function depositInventory() {
            if (!window.gameEngine || !window.gameEngine.bankingSystem) return;
            
            const bankingSystem = window.gameEngine.bankingSystem;
            const inventorySystem = window.gameEngine.inventorySystem;
            const player = window.gameEngine.player;
            
            let deposited = 0;
            
            // Deposit all inventory items (iterate backwards to avoid index issues)
            for (let i = inventorySystem.maxSlots - 1; i >= 0; i--) {
                const item = inventorySystem.getItemInSlot(i);
                if (item) {
                    const result = bankingSystem.depositItem(player, i, item.quantity);
                    if (result.success) {
                        deposited++;
                    }
                }
            }
            
            if (deposited > 0) {
                addSystemMessage(`Deposited ${deposited} item(s) to bank`);
                updateBankDisplay();
                updateInventoryDisplay();
            } else {
                addSystemMessage('No items to deposit', 'error');
            }
        }
        
        function depositEquipment() {
            if (!window.gameEngine || !window.gameEngine.bankingSystem) return;
            
            const bankingSystem = window.gameEngine.bankingSystem;
            const equipmentSystem = window.gameEngine.equipmentSystem;
            const inventorySystem = window.gameEngine.inventorySystem;
            const player = window.gameEngine.player;
            
            let deposited = 0;
            
            // Get all equipped items
            const equipped = equipmentSystem.getAllEquipped();
            
            // First unequip all to inventory, then deposit
            for (const [slotName, item] of Object.entries(equipped)) {
                if (item && item.itemId) {
                    // Unequip to inventory
                    const unequipResult = equipmentSystem.unequipItem(player, slotName);
                    if (unequipResult.success) {
                        // Find the item in inventory (it was just added)
                        for (let i = 0; i < inventorySystem.maxSlots; i++) {
                            const invItem = inventorySystem.getItemInSlot(i);
                            if (invItem && invItem.itemId === item.itemId) {
                                // Deposit it to bank
                                const depositResult = bankingSystem.depositItem(player, i, invItem.quantity);
                                if (depositResult.success) {
                                    deposited++;
                                }
                                break;
                            }
                        }
                    }
                }
            }
            
            if (deposited > 0) {
                addSystemMessage(`Deposited ${deposited} equipped item(s) to bank`);
                updateBankDisplay();
                updateInventoryDisplay();
                updateEquipmentDisplay();
            } else {
                addSystemMessage('No equipment to deposit', 'error');
            }
        }

        function openQuests() {
            addSystemMessage('Quest system coming in Phase 7!');
        }

        function openShop() {
            addSystemMessage('Shop system coming in Phase 6!');
        }

        function toggleSettings() {
            addSystemMessage('Settings panel coming soon!');
        }
    </script>
</body>
</html>
